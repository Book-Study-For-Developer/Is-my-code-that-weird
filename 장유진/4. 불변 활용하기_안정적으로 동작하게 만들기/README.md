# 4장 불변 활용하기: 안정적으로 동작하게 만들기

## 1. 재할당

변수에 값을 다시 할당하는 것을 **재할당** 또는 **파괴적 할당**이라고 합니다.<br>
이는 변수의 의미를 바꿔 추측하기 어렵게 만듭니다.

### 1.1 불변 변수로 만들어서 재할당 막기
기계적으로 불변을 막으려면 변수에 `final`수식자를 붙이기

### 1.2 매개변수도 불변으로 만들기
매개변수도 불변으로 만들어 의미가 변경되는 것을 막을 수 있습니다.

## 2. 가변으로 인해 발생하는 의도하지 않은 영향

### 2.1 사례 1: 가변 인스턴스 재사용하기
아래의 코드는 인스턴스 재사용시 한쪽의 변경이 다른 한쪽에 영향을 미치는 코드입니다.
```java
AttackPower attackPower = new AttackPower(20);

Weapon weaponA = new Weapon(attackPower);
Weapon weaponB = new Weapon(attackPower);

weaponA.attackPower.value = 25;

System.out.println("Weapon A attack power : " + weaponA.attackPower.value);
System.out.println("Weapon B attack power : " + weaponB.attackPower.value);
```

```
// 출력
Weapon A attack power : 25
Weapon B attack power : 25
```

### 2.2 사례 2: 함수로 가변 인스턴스 조작하기
클래스의 setter 함수로 값을 변경 시 서로 다른 스레드에서 같은 클래스 코드를 실행하면서, 의도하지 않은 값으로 변경될 수 있습니다.

### 2.3 부수 효과의 단점
`함수의 부수 효과란, '함수가 매개변수를 전달받고, 값을 리턴하는 것' 이외에 외부 상태(인스턴스 변수 등)을 변경하는 것을 가리킵니다.`

조금 더 자세히 설명하자면,
- 주요 작용: 함수(메서드)가 매개변수를 전달받고, 값을 리턴하는 것
- 부수 효과: 주요 작용 이외의 함수 밖에 있는 상태의 변경을 일으키는 것

상태 변경의 예시
- 인스턴스 변수 변경
- 전역 변수 변경
- 매개변수 변경
- 파일 읽고 쓰기 같은 I/O 조작

이러한 부수 효과를 가진 메서드를 만들 경우, 작업 실행 순서에 의존이 발생합니다. 또한 이런 코드는 결과를 예측하기 힘들며, 유지 보수하기 힘듭니다.

### 2.4 함수의 영향 범위 한정하기

함수를 설계할 때 만족해야 할 항목
- 데이터(상태)는 매개변수로 받습니다.
- 상태를 변경하지 않습니다.
- 값은 함수의 리턴 값으로 돌려줍니다.

인스턴스 변수는 불변으로 만들어 영향이 전달되지 않게 할 수 있으므로, 예상치 못한 동작 문제를 회피할 수 있습니다.

객체 지향 프로그래밍 언어는 함수의 부수 효과로 인한 범위를 클래스 내부까지 허용하는 것이 일반적입니다.<br>
따라서 보통은 인스턴스 변수를 동일한 클래스 메서드에서 사용하지 못하게 제한하진 않습니다. 

### 2.5 불변으로 만들어서 예기치 못한 동작 막기

`기능 변경 때에 의도하지 않게 부수 효과가 있는 함수가 만들어져서, 예상하지 못한 동작을 일으킬 가능성은 항상 존재합니다.`

변경된 값을 사용하고 싶다면 새로운 값을 가진 새로운 인스턴스 변수를 만들어서 사용해야 합니다.

## 3. 불변과 가변은 어떻게 다루어야 할까

### 3.1 기본적으로 불변으로

변수를 불변으로 만들었을 때의 장점
- 변수의 의미가 변하지 않으므로, 혼란을 줄일 수 있음.
- 동작이 안정적이게 되므로, 결과를 예측하기 쉬움.
- 코드의 영향 범위가 한정적이므로, 유지보수가 편리해짐.

러스트(Rust)에서는 불변이 디폴트 입니다. <br>
이처럼 최근 등장하는 프로그래밍 언어는 불변이 디폴트가 되도록 만들어지고 있습니다. <br>
그만큼 불변이라는 성질을 중요하게 여기는 것입니다.

### 3.2 가변으로 설계해야 하는 경우
성능(performance)이 중요한 경우 가변으로 설계하는 경우도 있습니다.
- 대량의 데이터를 빠르게 처리해야 하는 경우
- 이미지를 처리하는 경우
- 리소스에 제약이 큰 임베디드 소프트웨어를 다루는 경우

또한 스코프가 국소적인 경우에는 가변을 사용해도 좋습니다.<br>
예를 들어 반복문 카운터 등 반복 처리 스코프에서만 사용되는 지역 변수는 가변으로 해도 괜찮습니다.

### 3.3 상태를 변경하는 메서드 설계하기
상태를 변화시키는 메서드를 `뮤테이터(mutater)`라고 합니다.
인스턴스 변수를 가변으로 만들었다면 조건에 맞는 상태로 변경도록 뮤테이터를 잘 설계해야 합니다.

### 3.4 코드 외부와 데이터 교환은 국소화하기
불변을 활용하더라도 코드 외부와의 데이터 교환은 주의해야 합니다.<br>
특별한 이유 없이 외부 상태에 의존하는 코드를 작성하면, 동작 예측이 힘들어지므로 문제가 발생할 가능성이 높아집니다.

- 파일을 읽고 쓰는 I/O 조작
- 데이터베이스 사용

최근에는 이러한 영향을 그나마 줄을 수 있게, 코드 외부와 데이터 교환을 국소화하는 테크닉을 많이 사용합니다.<br>
예를 들어, 데이터베이스의 영속화를 캡슐화하는 디자인 패턴인 리포지터리 패턴(repository pattern)이 있습니다.

데이터베이스의 영속화란, 데이터베이스에 데이터를 저장하는 것을 의미합니다.